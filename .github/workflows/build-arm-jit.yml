# Build ARM32 JIT GitHub Action Workflow
# Requirements:
# - Cross-compilation for ARM32 (armhf) on Debian 12 Bookworm on an ARM runner
# - Uses system SDL2 package (has evdev/libinput support in Debian)
# - Configure BasiliskII with JIT enabled for ARM32
# - Target Raspberry Pi with 32-bit Raspberry Pi OS or 64-bit with armhf multiarch

name: Build ARM32 JIT

on:
  push:
    branches:
      - feature/arm-jit
    paths:
      - 'BasiliskII/src/**'
      - '.github/workflows/build-arm-jit.yml'
  pull_request:
    branches:
      - feature/arm-jit
    paths:
      - 'BasiliskII/src/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-arm32:
    name: ARM32 ${{ matrix.name }}
    runs-on: ubuntu-24.04-arm
    container:
      image: debian:bookworm

    strategy:
      fail-fast: false
      matrix:
        include:
          # Main JIT build with system SDL2 (no VOSF)
          - name: "JIT (System SDL2)"
            jit_enabled: true
            sdl_source: system
            vosf_enabled: false
            artifact_suffix: "-jit"
            
          # JIT build with VOSF enabled
          - name: "JIT + VOSF (System SDL2)"
            jit_enabled: true
            sdl_source: system
            vosf_enabled: true
            artifact_suffix: "-jit-vosf"
            
          # JIT build with vendored SDL2 (built from source)
          - name: "JIT (Vendored SDL2)"
            jit_enabled: true
            sdl_source: vendored
            vosf_enabled: false
            artifact_suffix: "-jit-vendored-sdl"
            
          # Non-JIT build to isolate video bugs from JIT bugs
          - name: "No-JIT (System SDL2)"
            jit_enabled: false
            sdl_source: system
            vosf_enabled: false
            artifact_suffix: "-nojit"
            
          # Non-JIT build with VOSF to isolate VOSF-specific issues
          - name: "No-JIT + VOSF (System SDL2)"
            jit_enabled: false
            sdl_source: system
            vosf_enabled: true
            artifact_suffix: "-nojit-vosf"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ARM32 cross-compilation environment
        run: |
          # Enable armhf architecture
          dpkg --add-architecture armhf
          apt-get update
          
          # Install cross-compiler and native build tools
          apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            crossbuild-essential-armhf \
            git \
            ca-certificates \
            wget

          # Install armhf development libraries
          apt-get install -y \
            libasound2-dev:armhf \
            libmpfr-dev:armhf \
            libudev-dev:armhf \
            libevdev-dev:armhf \
            libinput-dev:armhf \
            libdrm-dev:armhf \
            libgbm-dev:armhf

      - name: Install System SDL2
        if: matrix.sdl_source == 'system'
        run: |
          apt-get install -y libsdl2-dev:armhf
          echo "=== Checking SDL2 armhf package ==="
          dpkg -l | grep -i sdl2.*armhf || true
          ls -la /usr/lib/arm-linux-gnueabihf/libSDL2* || true

      - name: Build Vendored SDL2 from source
        if: matrix.sdl_source == 'vendored'
        run: |
          # Install SDL2 build dependencies for armhf
          apt-get install -y \
            cmake \
            libwayland-dev:armhf \
            libxkbcommon-dev:armhf \
            libegl1-mesa-dev:armhf \
            libgles2-mesa-dev:armhf \
            libpulse-dev:armhf
          
          # Download SDL2 source
          SDL2_VERSION=2.32.8
          wget -q https://github.com/libsdl-org/SDL/releases/download/release-${SDL2_VERSION}/SDL2-${SDL2_VERSION}.tar.gz
          tar xzf SDL2-${SDL2_VERSION}.tar.gz
          cd SDL2-${SDL2_VERSION}
          
          # Create cross-compile toolchain file for armhf
          cat > toolchain-armhf.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)
          set(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/arm-linux-gnueabihf)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(PKG_CONFIG_EXECUTABLE /usr/bin/arm-linux-gnueabihf-pkg-config)
          EOF
          
          # Build SDL2 with KMSDRM support
          mkdir build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=../toolchain-armhf.cmake \
            -DCMAKE_INSTALL_PREFIX=/opt/sdl2-armhf \
            -DSDL_SHARED=ON \
            -DSDL_STATIC=OFF \
            -DSDL_KMSDRM=ON \
            -DSDL_OPENGL=OFF \
            -DSDL_OPENGLES=ON \
            -DSDL_X11=OFF \
            -DSDL_WAYLAND=OFF \
            -DSDL_PULSEAUDIO=ON \
            -DSDL_ALSA=ON
          
          make -j$(nproc)
          make install
          
          echo "=== Vendored SDL2 installed ==="
          ls -la /opt/sdl2-armhf/lib/
          
          # Create pkg-config wrapper for vendored SDL2
          mkdir -p /opt/sdl2-armhf/lib/pkgconfig
          cat > /opt/sdl2-armhf/lib/pkgconfig/sdl2.pc << 'PKGEOF'
          prefix=/opt/sdl2-armhf
          exec_prefix=${prefix}
          libdir=${exec_prefix}/lib
          includedir=${prefix}/include
          
          Name: sdl2
          Description: Simple DirectMedia Layer
          Version: 2.32.8
          Libs: -L${libdir} -lSDL2
          Cflags: -I${includedir}/SDL2
          PKGEOF

      - name: Configure BasiliskII for ARM32
        run: |
          cd BasiliskII/src/Unix
          
          # Run autogen if configure doesn't exist
          if [ ! -f configure ]; then
            NO_CONFIGURE=1 ./autogen.sh || autoconf
          fi
          
          # Cross-compile for armhf
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          
          # Set PKG_CONFIG_PATH based on SDL source
          if [ "${{ matrix.sdl_source }}" = "vendored" ]; then
            export PKG_CONFIG_PATH=/opt/sdl2-armhf/lib/pkgconfig
            export LDFLAGS="-L/opt/sdl2-armhf/lib -Wl,-rpath,/opt/sdl2-armhf/lib"
            export CPPFLAGS="-I/opt/sdl2-armhf/include/SDL2"
          else
            export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
          fi
          
          # Set cross-compile variables for ARM Linux signal handling
          export BII_CROSS_HAVE_EXTENDED_SIGNALS=yes
          export BII_CROSS_SIGSEGV_SKIP_INSTRUCTION=yes
          export BII_CROSS_MMAP_ANON=yes
          export BII_CROSS_MMAP_SUPPORTS_MAP_ANONYMOUS=yes
          export BII_CROSS_MPROTECT_WORKS=yes
          
          # Build JIT option
          JIT_OPT=""
          if [ "${{ matrix.jit_enabled }}" = "true" ]; then
            JIT_OPT="--enable-jit-compiler"
          else
            JIT_OPT="--disable-jit-compiler"
          fi
          
          # Build VOSF option
          VOSF_OPT=""
          if [ "${{ matrix.vosf_enabled }}" = "true" ]; then
            VOSF_OPT="--enable-vosf"
          else
            VOSF_OPT="--disable-vosf"
          fi
          
          ./configure \
            --host=arm-linux-gnueabihf \
            --build=x86_64-linux-gnu \
            --enable-sdl-video \
            --enable-sdl-audio \
            $JIT_OPT \
            $VOSF_OPT \
            --enable-addressing=direct \
            --enable-fpe=ieee \
            --disable-gtk \
            --without-mon \
            --without-x \
            --without-esd \
            --disable-nls \
            --with-sdl2

      - name: Build BasiliskII
        run: |
          cd BasiliskII/src/Unix
          
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          
          if [ "${{ matrix.sdl_source }}" = "vendored" ]; then
            export PKG_CONFIG_PATH=/opt/sdl2-armhf/lib/pkgconfig
            export LDFLAGS="-L/opt/sdl2-armhf/lib -Wl,-rpath,/opt/sdl2-armhf/lib"
          else
            export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
          fi
          
          # Build and capture output
          make -j$(nproc) 2>&1 | tee build.log || {
            echo "=== Build failed - showing errors ==="
            grep -i "error:" build.log | head -50
            exit 1
          }

      - name: Verify ARM32 binary
        run: |
          cd BasiliskII/src/Unix
          file BasiliskII || echo "Binary not found"
          
          # Verify it's actually ARM32
          file BasiliskII | grep -q "ARM" && echo "✓ ARM binary confirmed"
          file BasiliskII | grep -q "32-bit" && echo "✓ 32-bit confirmed"
          
          # Check linked libraries
          echo "=== Linked libraries ==="
          arm-linux-gnueabihf-objdump -p BasiliskII | grep NEEDED || true
          
          # Check if JIT was enabled
          if [ "${{ matrix.jit_enabled }}" = "true" ]; then
            if grep -q "USE_JIT" config.h 2>/dev/null; then
              echo "✓ JIT compilation enabled"
              grep "USE_JIT" config.h
            else
              echo "✗ JIT not enabled in config (expected)"
              grep -E "CAN_JIT|CPU_arm" config.h || true
            fi
          else
            echo "JIT disabled for this build variant"
          fi

      - name: Prepare release artifact
        run: |
          cd BasiliskII/src/Unix
          mkdir -p release
          cp BasiliskII release/BasiliskII-arm32${{ matrix.artifact_suffix }}
          cp ../../../README.md release/ || true
          
          # Copy vendored SDL2 if used
          if [ "${{ matrix.sdl_source }}" = "vendored" ]; then
            mkdir -p release/lib
            cp /opt/sdl2-armhf/lib/libSDL2*.so* release/lib/
            echo "Vendored SDL2 libraries included in release/lib/" >> release/BUILD-INFO.txt
          fi
          
          # Create info file
          cat >> release/BUILD-INFO.txt << EOF
          BasiliskII ARM32 Build (${{ matrix.name }})
          ==========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          
          Configuration:
          - JIT Enabled: ${{ matrix.jit_enabled }}
          - VOSF Enabled: ${{ matrix.vosf_enabled }}
          - SDL2 Source: ${{ matrix.sdl_source }}
          
          Target: Raspberry Pi (32-bit armhf)
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: basilisk2-arm32${{ matrix.artifact_suffix }}
          path: |
            BasiliskII/src/Unix/release/
          retention-days: 30

  # Run blitter tests (Python validation)
  test-blitters:
    name: Validate Blitter Formulas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run blitter tests
        run: |
          python3 BasiliskII/src/CrossPlatform/test_blitters.py
          
  # Create release with all build variants
  create-release:
    name: Create Experimental Release
    runs-on: ubuntu-latest
    needs: [build-arm32, test-blitters]
    if: github.ref == 'refs/heads/feature/arm-jit' && github.event_name == 'push'
    
    steps:
      - name: Download JIT (System SDL2) artifact
        uses: actions/download-artifact@v4
        with:
          name: basilisk2-arm32-jit
          path: release/jit/
          
      - name: Download JIT + VOSF artifact
        uses: actions/download-artifact@v4
        with:
          name: basilisk2-arm32-jit-vosf
          path: release/jit-vosf/
          
      - name: Download JIT (Vendored SDL2) artifact
        uses: actions/download-artifact@v4
        with:
          name: basilisk2-arm32-jit-vendored-sdl
          path: release/jit-vendored-sdl/
          
      - name: Download No-JIT artifact
        uses: actions/download-artifact@v4
        with:
          name: basilisk2-arm32-nojit
          path: release/nojit/
          
      - name: Download No-JIT + VOSF artifact
        uses: actions/download-artifact@v4
        with:
          name: basilisk2-arm32-nojit-vosf
          path: release/nojit-vosf/
          
      - name: Create experimental release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: arm-jit-experimental
          target_commitish: ${{ github.sha }}
          name: "ARM JIT Experimental Build"
          prerelease: true
          make_latest: false
          body: |
            ## ⚠️ Experimental ARM JIT Build
            
            This is an **experimental** build of BasiliskII with ARM JIT support for 32-bit Raspberry Pi.
            
            ### Features
            - JIT compiler for ARM32 (armhf) ported from ARAnyM
            - Targets Raspberry Pi with 32-bit Raspberry Pi OS
            - Uses Debian system SDL2 with evdev/libinput input support
            - ALSA audio support
            
            ### Build Variants
            Five build variants are available:
            1. **JIT** - ARM JIT with system SDL2 (no VOSF)
            2. **JIT + VOSF** - ARM JIT with VOSF screen updates enabled
            3. **JIT (Vendored SDL2)** - ARM JIT with SDL2 built from source
            4. **No-JIT** - Interpreted CPU for debugging (no VOSF)
            5. **No-JIT + VOSF** - Interpreted CPU with VOSF enabled
            
            **VOSF** (Video On SEGV Fault) uses memory protection to detect which parts of the Mac framebuffer changed, potentially improving performance for partial screen updates.
            
            ### Requirements
            - 32-bit Raspberry Pi OS (armhf) / Debian 12 Bookworm
            - Runtime libraries:
              ```bash
              sudo apt install libmpfr6 libasound2 libudev1 libevdev2 libinput10 libdrm2 libgbm1
              ```
            - User must be in `input` group for console/KMSDRM input:
              ```bash
              sudo usermod -a -G input $USER
              # Then logout and login
              ```
            
            ### ⚠️ Warning
            This build is experimental and may have bugs or stability issues.
            The JIT compiler code was ported from ARAnyM and may not be fully tested.
            
            ### Commit
            Built from commit: ${{ github.sha }}
          files: |
            release/jit/*
            release/jit-vosf/*
            release/jit-vendored-sdl/*
            release/nojit/*
            release/nojit-vosf/*
