name: Build ARM32 JIT

on:
  push:
    branches:
      - feature/arm-jit
      - main
    paths:
      - 'BasiliskII/src/**'
      - '.github/workflows/build-arm-jit.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'BasiliskII/src/**'
  workflow_dispatch:

jobs:
  build-arm32-jit:
    name: Experimental ARM32 JIT (cross-compile on ARM64, Debian 12)
    runs-on: ubuntu-24.04-arm
    container:
      image: debian:bookworm
    
    steps:
      - name: Install git and dependencies
        run: |
          apt-get update
          apt-get install -y git ca-certificates

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ARM32 cross-compilation
        run: |
          # Enable armhf architecture on ARM64 host
          dpkg --add-architecture armhf
          apt-get update
          
          # Install cross-compiler and native build tools
          apt-get install -y \
            autoconf \
            automake \
            libtool \
            pkg-config \
            crossbuild-essential-armhf \
            file
          
          # Install armhf libraries (including OpenGL ES 2 for SDL rendering)
          apt-get install -y \
            libsdl2-dev:armhf \
            libasound2-dev:armhf \
            libmpfr-dev:armhf \
            libgles2:armhf \
            libgles-dev:armhf \
            libudev-dev:armhf

      - name: Configure BasiliskII for ARM32 with JIT
        run: |
          cd BasiliskII/src/Unix
          
          # Run autogen if configure doesn't exist
          if [ ! -f configure ]; then
            NO_CONFIGURE=1 ./autogen.sh || autoconf
          fi
          
          # Cross-compile for armhf with JIT enabled
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
          
          # Set cross-compile variables for ARM Linux signal handling
          # Modern ARM Linux uses siginfo_t with extended signals
          export BII_CROSS_HAVE_EXTENDED_SIGNALS=yes
          export BII_CROSS_SIGSEGV_SKIP_INSTRUCTION=yes
          export BII_CROSS_MMAP_ANON=yes
          export BII_CROSS_MMAP_SUPPORTS_MAP_ANONYMOUS=yes
          export BII_CROSS_MPROTECT_WORKS=yes
          
          ./configure \
            --host=arm-linux-gnueabihf \
            --build=aarch64-linux-gnu \
            --enable-sdl-video \
            --enable-sdl-audio \
            --enable-jit-compiler \
            --enable-addressing=direct \
            --enable-fpe=ieee \
            --disable-vosf \
            --disable-gtk \
            --without-mon \
            --without-x \
            --without-esd \
            --disable-nls \
            --with-sdl2

      - name: Build BasiliskII with ARM32 JIT
        run: |
          cd BasiliskII/src/Unix
          
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          
          # Build and capture output
          make -j$(nproc) 2>&1 | tee build.log || {
            echo "=== Build failed - showing errors ==="
            grep -i "error:" build.log | head -50
            exit 1
          }

      - name: Verify ARM32 JIT binary
        run: |
          cd BasiliskII/src/Unix
          file BasiliskII || echo "Binary not found"
          
          # Verify it's actually ARM32
          file BasiliskII | grep -q "ARM" && echo "✓ ARM binary confirmed"
          file BasiliskII | grep -q "32-bit" && echo "✓ 32-bit confirmed"
          
          # Check if JIT was enabled
          if grep -q "USE_JIT" config.h 2>/dev/null; then
            echo "✓ JIT compilation enabled"
            grep "USE_JIT" config.h
          else
            echo "✗ JIT not enabled in config"
            grep -E "CAN_JIT|CPU_arm" config.h || true
          fi

      - name: Prepare release artifact
        run: |
          cd BasiliskII/src/Unix
          mkdir -p release
          cp BasiliskII release/BasiliskII-arm32-jit
          cp ../../../README.md release/ || true
          
          # Create info file
          cat > release/BUILD-INFO.txt << EOF
          BasiliskII ARM32 JIT Build
          ==========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${{ github.sha }}
          Git Branch: ${{ github.ref_name }}
          
          This is an EXPERIMENTAL build with ARM JIT support.
          Target: Raspberry Pi (32-bit Raspberry Pi OS)
          
          JIT code ported from ARAnyM project.
          EOF

      - name: Upload ARM32 JIT binary
        uses: actions/upload-artifact@v4
        with:
          name: basilisk2-arm32-jit
          path: |
            BasiliskII/src/Unix/release/
          retention-days: 30

      - name: Create experimental release
        if: github.ref == 'refs/heads/feature/arm-jit' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: arm-jit-experimental
          name: "ARM JIT Experimental Build"
          prerelease: true
          make_latest: false
          body: |
            ## ⚠️ Experimental ARM JIT Build
            
            This is an **experimental** build of BasiliskII with ARM JIT support for 32-bit Raspberry Pi.
            
            ### Features
            - JIT compiler for ARM32 (armhf) ported from ARAnyM
            - Targets Raspberry Pi with 32-bit Raspberry Pi OS
            - SDL2 video and audio support with OpenGL ES 2 rendering
            
            ### Requirements
            - 32-bit Raspberry Pi OS (armhf)
            - SDL2 runtime libraries (`sudo apt install libsdl2-2.0-0`)
            - MPFR library (`sudo apt install libmpfr6`)
            - OpenGL ES 2 libraries (`sudo apt install libgles2-mesa`)
            
            ### ⚠️ Warning
            This build is experimental and may have bugs or stability issues.
            The JIT compiler code was ported from ARAnyM and may not be fully tested.
            
            ### Commit
            Built from commit: ${{ github.sha }}
          files: |
            BasiliskII/src/Unix/release/*
